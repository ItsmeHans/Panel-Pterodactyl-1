#!/usr/bin/env bash
set -euo pipefail

# Pilih perintah compose
if docker compose version >/dev/null 2>&1; then
  DC="docker compose"
elif command -v docker-compose >/dev/null 2>&1; then
  DC="docker-compose"
else
  echo "âŒ Docker Compose tidak ditemukan. Instal Docker terlebih dahulu."
  exit 1
fi

echo "ğŸª½ Pterodactyl Wings - MODE MANUAL"

# Buat struktur direktori
mkdir -p pterodactyl/wings/config
cd pterodactyl/wings

# Tulis docker-compose.yml (tanpa key 'version' biar tidak ada warning)
cat > docker-compose.yml <<'YML'
services:
  wings:
    image: ghcr.io/pterodactyl/wings:latest
    container_name: wings
    restart: always
    networks:
      - wings0
    ports:
      - "8080:8080"   # API/HTTP Wings
      - "2022:2022"   # SFTP
    tty: true
    environment:
      TZ: Asia/Jakarta
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/containers/:/var/lib/docker/containers/
      - ./config:/etc/pterodactyl/
      - /var/lib/pterodactyl/:/var/lib/pterodactyl/
      - /var/log/pterodactyl/:/var/log/pterodactyl/
      - /tmp/pterodactyl/:/tmp/pterodactyl/
      - /etc/ssl/certs:/etc/ssl/certs:ro

networks:
  wings0:
    name: wings0
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
    driver_opts:
      com.docker.network.bridge.name: wings0
YML

# Pastikan file config ada, kalau belum -> buka editor untuk paste YAML dari Panel
CONF="config/config.yml"
if [[ ! -s "$CONF" ]]; then
  echo
  echo "ğŸ“„ Sekarang paste **SELURUH YAML Node** dari Panel â†’ Admin â†’ Nodes â†’ (pilih node) â†’ Configuration â†’ Show/Generate Configuration."
  echo "   File tujuan: $(pwd)/$CONF"
  mkdir -p config
  touch "$CONF"

  if command -v nano >/dev/null 2>&1; then
    echo "âœï¸  Membuka nanoâ€¦ (paste YAML, lalu Ctrl+O Enter, Ctrl+X)"
    nano "$CONF"
  elif command -v vim >/dev/null 2>&1; then
    echo "âœï¸  Membuka vimâ€¦ (paste, :wq untuk simpan)"
    vim "$CONF"
  elif command -v vi >/dev/null 2>&1; then
    echo "âœï¸  Membuka viâ€¦ (paste, :wq untuk simpan)"
    vi "$CONF"
  else
    echo "âŒ¨ï¸  Tidak ada editor (nano/vim/vi). Gunakan metode paste manual:"
    echo "    Jalankan perintah ini di terminal lain:"
    echo "      cat > $(pwd)/$CONF"
    echo "    lalu paste YAML dan tekan Ctrl+D untuk simpan."
    read -rp "Tekan Enter setelah file $CONF sudah terisi..."
  fi
fi

# Validasi sederhana: file tidak kosong
if [[ ! -s "$CONF" ]]; then
  echo "âŒ $CONF masih kosong. Pastikan kamu sudah paste YAML Node."
  exit 1
fi

echo "ğŸš€ Menjalankan Wings..."
$DC up -d

echo
echo "âœ… Selesai. Cek di Panel â†’ Nodes apakah status Node sudah 'connected'."
echo "   Jika belum, periksa kembali FQDN, ports, dan SSL di YAML config."
