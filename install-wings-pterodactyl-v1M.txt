#!/usr/bin/env bash
set -euo pipefail

# Pilih perintah compose
if docker compose version >/dev/null 2>&1; then
  DC="docker compose"
elif command -v docker-compose >/dev/null 2>&1; then
  DC="docker-compose"
else
  echo "❌ Docker Compose tidak ditemukan. Instal Docker terlebih dahulu."
  exit 1
fi

echo "🪽 Pterodactyl Wings - MODE MANUAL"

# Buat struktur direktori
mkdir -p pterodactyl/wings
cd pterodactyl/wings

# Tulis docker-compose.yml (tanpa key 'version' biar tidak ada warning)
cat > docker-compose.yml <<'YML'
services:
  wings:
    image: ghcr.io/pterodactyl/wings:latest
    container_name: wings
    restart: always
    networks:
      - wings0
    ports:
      - "8080:8080"   # API/HTTP Wings
      - "2022:2022"   # SFTP
      - "443:443"
    tty: true
    environment:
      TZ: Asia/Jakarta
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/containers/:/var/lib/docker/containers/
      - /etc/pterodactyl/:/etc/pterodactyl/
      - /var/lib/pterodactyl/:/var/lib/pterodactyl/
      - /var/log/pterodactyl/:/var/log/pterodactyl/
      - /tmp/pterodactyl/:/tmp/pterodactyl/
      - /etc/ssl/certs:/etc/ssl/certs:ro

networks:
  wings0:
    name: wings0
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
    driver_opts:
      com.docker.network.bridge.name: wings0
YML

# Pastikan file config ada, kalau belum -> buka editor untuk paste YAML dari Panel
CONF="config.yml"

# Validasi sederhana: file tidak kosong
if [[ ! -s "$CONF" ]]; then
  echo "❌ $CONF masih kosong. Pastikan kamu sudah paste YAML Node."
  exit 1
fi

echo "🚀 Menjalankan Wings..."
$DC up -d

echo
echo "✅ Wings Sudah Selesai. 1 Langkah lagi yaitu copy paste Configuration File Node Panel ke config.yml."
