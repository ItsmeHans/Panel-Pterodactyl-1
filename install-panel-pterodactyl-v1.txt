#!/usr/bin/env bash
set -euo pipefail


echo "📦 Installing Pterodactyl Panel (Docker Compose)"

# Pilih perintah compose (v2: 'docker compose', fallback ke 'docker-compose')
if docker compose version >/dev/null 2>&1; then
  DC="docker compose"
else
  DC="docker-compose"
fi

# Direktori kerja
mkdir -p pterodactyl/panel
cd pterodactyl/panel

# Buat docker-compose.yml
cat > docker-compose.yml <<'YML'
version: "3.8"

services:
  database:
    image: mariadb:10.11
    restart: always
    command:
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_DATABASE: panel
      MYSQL_USER: pterodactyl
      MYSQL_PASSWORD: CHANGE_ME_DB_USER
      MYSQL_ROOT_PASSWORD: CHANGE_ME_DB_ROOT
      TZ: Asia/Jakarta
    volumes:
      - /srv/pterodactyl/database:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-pCHANGE_ME_DB_ROOT"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    restart: always
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  panel:
    image: ghcr.io/pterodactyl/panel:latest
    restart: always
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "80:80"
      # Jika ingin TLS via reverse proxy di host, biarkan 443 di host untuk proxy—tidak perlu expose 443 dari container panel.
    environment:
      TZ: Asia/Jakarta
      APP_ENV: production
      APP_ENVIRONMENT_ONLY: false
      APP_URL: https://pterodactyl.example.com
      APP_TIMEZONE: Asia/Jakarta
      TRUSTED_PROXIES: "*"

      # Database
      DB_HOST: database
      DB_PORT: 3306
      DB_DATABASE: panel
      DB_USERNAME: pterodactyl
      DB_PASSWORD: CHANGE_ME_DB_USER

      # Cache/Queue/Session
      CACHE_DRIVER: redis
      QUEUE_CONNECTION: redis
      SESSION_DRIVER: redis
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # Mail (sesuaikan; contoh pakai MailHog/Local SMTP)
      MAIL_MAILER: smtp
      MAIL_HOST: mail
      MAIL_PORT: 1025
      MAIL_USERNAME: ""
      MAIL_PASSWORD: ""
      MAIL_ENCRYPTION: null
      MAIL_FROM: noreply@example.com
    volumes:
      - /srv/pterodactyl/var:/app/var
      - /srv/pterodactyl/logs:/app/storage/logs
YML

# Jalankan stack
$DC up -d

echo "⏳ Menunggu container panel siap (sleep 15s)..."
sleep 15

# Generate APP_KEY & migrate database
echo "🔑 Generate APP_KEY..."
$DC exec panel php artisan key:generate --force

echo "🗄️  Migrate database..."
$DC exec panel php artisan migrate --force

# Buat admin user
echo "👤 Buat admin user panel..."
$DC exec panel php artisan p:user:make

echo "✅ Selesai! Akses via: http://YOUR_SERVER_IP/ (atau domain di APP_URL)"
